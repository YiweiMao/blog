<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Ping Pong LED Clock | Yiwei Mao</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Ping Pong LED Clock" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="How I built and programmed my own Ping Pong LED clock with firework animations." />
<meta property="og:description" content="How I built and programmed my own Ping Pong LED clock with firework animations." />
<link rel="canonical" href="https://yiweimao.github.io/blog/ping_pong_led_clock/" />
<meta property="og:url" content="https://yiweimao.github.io/blog/ping_pong_led_clock/" />
<meta property="og:site_name" content="Yiwei Mao" />
<meta property="og:image" content="https://yiweimao.github.io/blog/images/2021-01-05-LED_clock_files/bright_clock.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-01-14T00:00:00-06:00" />
<script type="application/ld+json">
{"headline":"Ping Pong LED Clock","dateModified":"2021-01-14T00:00:00-06:00","datePublished":"2021-01-14T00:00:00-06:00","description":"How I built and programmed my own Ping Pong LED clock with firework animations.","mainEntityOfPage":{"@type":"WebPage","@id":"https://yiweimao.github.io/blog/ping_pong_led_clock/"},"image":"https://yiweimao.github.io/blog/images/2021-01-05-LED_clock_files/bright_clock.png","@type":"BlogPosting","url":"https://yiweimao.github.io/blog/ping_pong_led_clock/","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/blog/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://yiweimao.github.io/blog/feed.xml" title="Yiwei Mao" /><!-- the google_analytics_id gets auto inserted from the config file -->



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-61578211-2','auto');ga('require','displayfeatures');ga('send','pageview');</script>

<link rel="shortcut icon" type="image/x-icon" href="/blog/images/favicon.ico"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Ping Pong LED Clock | Yiwei Mao</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Ping Pong LED Clock" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="How I built and programmed my own Ping Pong LED clock with firework animations." />
<meta property="og:description" content="How I built and programmed my own Ping Pong LED clock with firework animations." />
<link rel="canonical" href="https://yiweimao.github.io/blog/ping_pong_led_clock/" />
<meta property="og:url" content="https://yiweimao.github.io/blog/ping_pong_led_clock/" />
<meta property="og:site_name" content="Yiwei Mao" />
<meta property="og:image" content="https://yiweimao.github.io/blog/images/2021-01-05-LED_clock_files/bright_clock.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-01-14T00:00:00-06:00" />
<script type="application/ld+json">
{"headline":"Ping Pong LED Clock","dateModified":"2021-01-14T00:00:00-06:00","datePublished":"2021-01-14T00:00:00-06:00","description":"How I built and programmed my own Ping Pong LED clock with firework animations.","mainEntityOfPage":{"@type":"WebPage","@id":"https://yiweimao.github.io/blog/ping_pong_led_clock/"},"image":"https://yiweimao.github.io/blog/images/2021-01-05-LED_clock_files/bright_clock.png","@type":"BlogPosting","url":"https://yiweimao.github.io/blog/ping_pong_led_clock/","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet" />
<link rel="stylesheet" href="//use.fontawesome.com/releases/v5.0.7/css/all.css"><link type="application/atom+xml" rel="alternate" href="https://yiweimao.github.io/blog/feed.xml" title="Yiwei Mao" /><!-- the google_analytics_id gets auto inserted from the config file -->



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-61578211-2','auto');ga('require','displayfeatures');ga('send','pageview');</script>


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
    <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"> </script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head><body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/blog/">Yiwei Mao</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/blog/about/">About Me</a><a class="page-link" href="/blog/search/">Search</a><a class="page-link" href="/blog/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Ping Pong LED Clock</h1><p class="page-description">How I built and programmed my own Ping Pong LED clock with firework animations.</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2021-01-14T00:00:00-06:00" itemprop="datePublished">
        Jan 14, 2021
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      14 min read
    
</span></p>

    

    
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h1"><a href="#Introduction">Introduction </a></li>
<li class="toc-entry toc-h1"><a href="#Materials">Materials </a></li>
<li class="toc-entry toc-h1"><a href="#The-Build">The Build </a></li>
<li class="toc-entry toc-h1"><a href="#LED-Index-Look-Up-Table">LED Index Look Up Table </a>
<ul>
<li class="toc-entry toc-h2"><a href="#FastLED-Frame-Buffer">FastLED Frame Buffer </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Setting-Colours">Setting Colours </a></li>
<li class="toc-entry toc-h3"><a href="#Power-consumption">Power consumption </a></li>
<li class="toc-entry toc-h3"><a href="#Timing">Timing </a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#Foreground-Modes">Foreground Modes </a>
<ul>
<li class="toc-entry toc-h2"><a href="#Slanted-Digits">Slanted Digits </a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#Background-Animations">Background Animations </a>
<ul>
<li class="toc-entry toc-h2"><a href="#Rolling-Rainbow">Rolling Rainbow </a></li>
<li class="toc-entry toc-h2"><a href="#Twinkle">Twinkle </a></li>
<li class="toc-entry toc-h2"><a href="#Storm">Storm </a></li>
<li class="toc-entry toc-h2"><a href="#Campfire">Campfire </a></li>
<li class="toc-entry toc-h2"><a href="#Fireworks">Fireworks </a></li>
<li class="toc-entry toc-h2"><a href="#General-Animation-Method">General Animation Method </a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#Potential-Improvements">Potential Improvements </a></li>
<li class="toc-entry toc-h1"><a href="#Conclusion">Conclusion </a></li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2021-01-14-led_clock.ipynb
-->

<div class="container" id="notebook-container">
        
    
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Introduction">
<a class="anchor" href="#Introduction" aria-hidden="true"><span class="octicon octicon-link"></span></a>Introduction<a class="anchor-link" href="#Introduction"> </a>
</h1>
<p><img src="/blog/images/copied_from_nb/../images/2021-01-05-LED_clock_files/bright_clock.png" alt="" title="Figure 1: The final product showing the time."></p>
<p>Ping pong balls are great light diffusers and combining them with individually addressable RGB LEDs makes for a pretty display. This ping pong clock can show the time and background animations (more on that later). Since each "pixel" is placed in a hexagonal close packed (single layer though), the typical digits font for standard 7-segement displays can't be used unless the digits are slanted.</p>
<p>In this blog post, I will describe how I built the thing and my reasoning behind some design choices. Then I will outline how I created my animations so you can fork my repository and create your own animations. At the end, there will be some animations for you to watch!</p>
<p>My code can be found at this <a href="https://github.com/YiweiMao/pingPongClock">repo link</a>.</p>
<h1 id="Materials">
<a class="anchor" href="#Materials" aria-hidden="true"><span class="octicon octicon-link"></span></a>Materials<a class="anchor-link" href="#Materials"> </a>
</h1>
<p>I ordered all the materials to build this well before the global pandemic but only got to making it recently. The ping pong balls and LED strip took many weeks to arrive shipping from overseas.</p>
<ul>
<li>At least 128 ping pong balls. I used low cost "glossy" plasticky ping pong balls ~$20. Better to use proper ping pong balls that diffuse the light well.</li>
<li>5 m of WS2128B LED strip at 30 LEDS/m. (This gives you 150 RGB LEDS which is more than the required 128. ~$20)</li>
<li>2 m of 3pin wire ~$3. You can use single connection multicore wire as an alternative. </li>
<li>Some lead-free solder ~$2. Any solder will do really. </li>
<li>Microcontroller (I used an Arduino Nano Clone ~$3. Not enough RAM for scrolling text animations so consider an ESP32 board?) </li>
<li>A Real Time Clock with coin cell battery. I didn't have one so I used a software implementation instead. That meant I couldn't keep track of the right time after a powerdown. But hey, a broken clock is right twice a day!</li>
<li>MDF board to put all LEDs onto ~$4.</li>
<li>Wood Frame ~$5. You will need a miter saw to cut the frame at 60 degree angles.</li>
<li>Some screws/nails/epoxy to fit the frame together ~$1.</li>
<li>Lots of hot glue. I used a 30 cm stick ~$1.</li>
<li>A 5 V power supply. I'm using a phone charger which can provide up to 2 A of current. If you plan to turn all the LEDs to max brightness, you'll need like 8 A but for all intents and purposes, I think 2 A is enough. You can use a <code>FastLED</code> setting to set a limit to the power draw and the brightness will automatically adjust for you. </li>
</ul>
<p>The <a href="https://www.instructables.com/Ping-Pong-Ball-LED-Clock/">original instructable</a> which describes how to build and program the LED clock is a great resource so definitely take a look! In it, he/she uses competition quality ping pong balls rather than the cheap ones I used which tended to be glossy and inconsistent in the amount of plastic for each ball. I'm inclined to agree that the higher quality ping pong balls are way better despite being more costly. The cheap plasticky ping pong balls don't diffuse the light enough and the LED position can seen from behind. If you do choose to use the cheap ping pong balls however, I found that you can recreate the really great light diffusion by <em>stacking</em> two cut halves together. Looking from afar, I can't notice any blemishes (or at least, my mind won't let me).</p>
<h1 id="The-Build">
<a class="anchor" href="#The-Build" aria-hidden="true"><span class="octicon octicon-link"></span></a>The Build<a class="anchor-link" href="#The-Build"> </a>
</h1>
<p>From a bag of 150 ping pong balls,</p>
<p><img src="/blog/images/copied_from_nb/../images/2021-01-05-LED_clock_files/ball_bag.png" alt="" title="Figure 2: Bag of cheap ping pong balls."></p>
<p>each ball goes into a jig I made using LEGO to hold the ball in place while I used an X-acto knife to slice along the seam. If you don't slice along the seam, you can see the seam when you shine the LED behind it! This is the most tedious part and took me a whole day.</p>
<p><img src="/blog/images/copied_from_nb/../images/2021-01-05-LED_clock_files/jig.png" alt="" title="Figure 3: Jig to slice each ping pong ball along the visible seam."></p>
<p>I then used hot glue to double stack each half to improve the diffusion. Once the improved halves are done, I glued two together while aligning it to a flat surface (edge of a tissue box in my case). The instructable used two long lengths of wood to ensure each row is straight - it's impossible to mess up the straight line gluing two pieces together. Then extend to the final shape shown in Figure 6 (2 rows of 17, 2 rows of 18, 2 rows of 19 and 1 row of 20). I used hot glue quite liberally to make the structure rigid but it still ended up rather fragile - not a problem once it's in the frame and glued down.</p>
<p><img src="/blog/images/copied_from_nb/../images/2021-01-05-LED_clock_files/glued.png" alt="" title="Figure 4: Used hot glue to stick halves together."></p>
<p>I cut the LED strips such that the included JST connector both starts and ends the whole thing and these connectors are pulled through a 12 mm diameter hole. This means you can provide 5 V power from both ends. I follwed the wiring shown in Figure 8. Keep in mind the direction shown on the strip! I found that the wiring wasn't noticible after the ping pong balls were placed so didn't bother putting them behind the MDF board like the instructable. Sticky tape was used to temporarilly fix the strip positions while I test for light leakage after placing the ping pong balls on top.</p>
<p><img src="/blog/images/copied_from_nb/../images/2021-01-05-LED_clock_files/fixed_leds.png" alt="" title="Figure 5: Cut strips of WS2128B LEDs wired together."></p>
<p>The reason why I'm not providing exact dimensions for the frame is that the dimensions will depend on how well you glue all the ping pong ball pieces together. Since each ping pong ball was 40 mm diameter, the row of 20 should be 800 mm long but mine ended up being 810 mm. With the frame, the overall dimensions was roughly 850 mm long and 290 mm tall.</p>
<p><img src="/blog/images/copied_from_nb/../images/2021-01-05-LED_clock_files/frame.png" alt="" title="Figure 6: Ping pong ball halves aligned to the LED strips."></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p></p>
<div class="flash flash-success">
    <svg class="octicon octicon-checklist octicon octicon-checklist" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M16 8.5l-6 6-3-3L8.5 10l1.5 1.5L14.5 7 16 8.5zM5.7 12.2l.8.8H2c-.55 0-1-.45-1-1V3c0-.55.45-1 1-1h7c.55 0 1 .45 1 1v6.5l-.8-.8c-.39-.39-1.03-.39-1.42 0L5.7 10.8a.996.996 0 000 1.41v-.01zM4 4h5V3H4v1zm0 2h5V5H4v1zm0 2h3V7H4v1zM3 9H2v1h1V9zm0-2H2v1h1V7zm0-2H2v1h1V5zm0-2H2v1h1V3z"></path></svg>
    <strong>Tip: </strong>Make sure you have some space behind the frame to place the microcontroller and power supply. 
</div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Before you fix the LED strips in place with more hot glue, turn on all the LEDs and make sure each LED is underneath a ping pong ball. Look up the <a href="https://github.com/FastLED/FastLED">FastLED library</a> to see how to do this - it's very simple and there are great example codes to run!</p>
<p><img src="/blog/images/copied_from_nb/../images/2021-01-05-LED_clock_files/rainbow_test.png" alt="" title="Figure 7: Test for light leakage."></p>
<h1 id="LED-Index-Look-Up-Table">
<a class="anchor" href="#LED-Index-Look-Up-Table" aria-hidden="true"><span class="octicon octicon-link"></span></a>LED Index Look Up Table<a class="anchor-link" href="#LED-Index-Look-Up-Table"> </a>
</h1>
<p>The crux of my animations rely on knowing when LED number along the connected strip of 128 corresponds to a two dimensional position. From Figure 8, I label each LED by it's strip number which you can see in Figure 9.</p>
<p><img src="/blog/images/copied_from_nb/../images/2021-01-05-LED_clock_files/led_circuit.png" alt="" title="Figure 8: Orientation of LED strips."></p>
<p><img src="/blog/images/copied_from_nb/../images/2021-01-05-LED_clock_files/balls.png" alt="" title="Figure 9: Internal LED index for each ping pong ball."></p>
<p>Imagining the display as a parallelogram slanted to the left, I turned Figure 9 into a two dimensional array (look up table) with values corresponding to the strip index. For the positions that don't exist, I put values of 999.</p>
<div class="highlight"><pre><span></span><span class="k">const</span> <span class="kt">int</span> <span class="n">led_address</span><span class="p">[</span><span class="mi">7</span><span class="p">][</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="p">{</span><span class="mi">999</span><span class="p">,</span><span class="mi">999</span><span class="p">,</span><span class="mi">999</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">26</span><span class="p">,</span><span class="mi">27</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">41</span><span class="p">,</span><span class="mi">54</span><span class="p">,</span><span class="mi">55</span><span class="p">,</span><span class="mi">68</span><span class="p">,</span><span class="mi">69</span><span class="p">,</span><span class="mi">82</span><span class="p">,</span><span class="mi">83</span><span class="p">,</span><span class="mi">96</span><span class="p">,</span><span class="mi">97</span><span class="p">,</span><span class="mi">110</span><span class="p">,</span><span class="mi">111</span><span class="p">,</span><span class="mi">124</span><span class="p">},</span>  <span class="c1">// 0th row</span>
  <span class="p">{</span><span class="mi">999</span><span class="p">,</span><span class="mi">999</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">25</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mi">39</span><span class="p">,</span><span class="mi">42</span><span class="p">,</span><span class="mi">53</span><span class="p">,</span><span class="mi">56</span><span class="p">,</span><span class="mi">67</span><span class="p">,</span><span class="mi">70</span><span class="p">,</span><span class="mi">81</span><span class="p">,</span><span class="mi">84</span><span class="p">,</span><span class="mi">95</span><span class="p">,</span><span class="mi">98</span><span class="p">,</span><span class="mi">109</span><span class="p">,</span><span class="mi">112</span><span class="p">,</span><span class="mi">123</span><span class="p">},</span>    <span class="c1">// 1st row</span>
  <span class="p">{</span><span class="mi">999</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">24</span><span class="p">,</span><span class="mi">29</span><span class="p">,</span><span class="mi">38</span><span class="p">,</span><span class="mi">43</span><span class="p">,</span><span class="mi">52</span><span class="p">,</span><span class="mi">57</span><span class="p">,</span><span class="mi">66</span><span class="p">,</span><span class="mi">71</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="mi">85</span><span class="p">,</span><span class="mi">94</span><span class="p">,</span><span class="mi">99</span><span class="p">,</span><span class="mi">108</span><span class="p">,</span><span class="mi">113</span><span class="p">,</span><span class="mi">122</span><span class="p">,</span><span class="mi">125</span><span class="p">},</span>    <span class="c1">// 2nd row</span>
  <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">23</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">37</span><span class="p">,</span><span class="mi">44</span><span class="p">,</span><span class="mi">51</span><span class="p">,</span><span class="mi">58</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">72</span><span class="p">,</span><span class="mi">79</span><span class="p">,</span><span class="mi">86</span><span class="p">,</span><span class="mi">93</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">107</span><span class="p">,</span><span class="mi">114</span><span class="p">,</span><span class="mi">121</span><span class="p">,</span><span class="mi">126</span><span class="p">},</span>      <span class="c1">// 3rd row</span>
  <span class="p">{</span><span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mi">31</span><span class="p">,</span><span class="mi">36</span><span class="p">,</span><span class="mi">45</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">59</span><span class="p">,</span><span class="mi">64</span><span class="p">,</span><span class="mi">73</span><span class="p">,</span><span class="mi">78</span><span class="p">,</span><span class="mi">87</span><span class="p">,</span><span class="mi">92</span><span class="p">,</span><span class="mi">101</span><span class="p">,</span><span class="mi">106</span><span class="p">,</span><span class="mi">115</span><span class="p">,</span><span class="mi">120</span><span class="p">,</span><span class="mi">127</span><span class="p">,</span><span class="mi">999</span><span class="p">},</span>    <span class="c1">// 4th row</span>
  <span class="p">{</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">35</span><span class="p">,</span><span class="mi">46</span><span class="p">,</span><span class="mi">49</span><span class="p">,</span><span class="mi">60</span><span class="p">,</span><span class="mi">63</span><span class="p">,</span><span class="mi">74</span><span class="p">,</span><span class="mi">77</span><span class="p">,</span><span class="mi">88</span><span class="p">,</span><span class="mi">91</span><span class="p">,</span><span class="mi">102</span><span class="p">,</span><span class="mi">105</span><span class="p">,</span><span class="mi">116</span><span class="p">,</span><span class="mi">119</span><span class="p">,</span><span class="mi">999</span><span class="p">,</span><span class="mi">999</span><span class="p">},</span>    <span class="c1">// 5th row</span>
  <span class="p">{</span><span class="mi">6</span><span class="p">,</span><span class="mi">19</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">33</span><span class="p">,</span><span class="mi">34</span><span class="p">,</span><span class="mi">47</span><span class="p">,</span><span class="mi">48</span><span class="p">,</span><span class="mi">61</span><span class="p">,</span><span class="mi">62</span><span class="p">,</span><span class="mi">75</span><span class="p">,</span><span class="mi">76</span><span class="p">,</span><span class="mi">89</span><span class="p">,</span><span class="mi">90</span><span class="p">,</span><span class="mi">103</span><span class="p">,</span><span class="mi">104</span><span class="p">,</span><span class="mi">117</span><span class="p">,</span><span class="mi">118</span><span class="p">,</span><span class="mi">999</span><span class="p">,</span><span class="mi">999</span><span class="p">,</span><span class="mi">999</span><span class="p">},</span>  <span class="c1">// 6th row</span>
<span class="p">};</span>
</pre></div>
<p>Now that I have access to the row and coloumn in the ping pong display, I went ahead and added custom animations.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p></p>
<div class="flash flash-warn">
    <svg class="octicon octicon-zap octicon octicon-zap" viewbox="0 0 10 16" version="1.1" width="10" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M10 7H6l3-7-9 9h4l-3 7 9-9z"></path></svg>
    <strong>Important: </strong>Using this look up table together with arrays of structs for storing animation state quickly ate up the RAM on my Arduino Nano (which has 2 KB). To add more complex animations and scrolling text, you will need something like a Teensy or ESP32. I haven’t tried it yet, but this <a href="https://www.adafruit.com/product/4600">Qt Py</a> seems like a viable cheap Arduino compatible option with 32 KB of RAM.
</div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="FastLED-Frame-Buffer">
<a class="anchor" href="#FastLED-Frame-Buffer" aria-hidden="true"><span class="octicon octicon-link"></span></a>FastLED Frame Buffer<a class="anchor-link" href="#FastLED-Frame-Buffer"> </a>
</h2>
<p>I used the <a href="https://github.com/FastLED/FastLED">FastLED library</a> for controlling all 128 RGB LEDs. After connecting 5 V and GND, the remaining data pin can be connected to any digital pin (I used pin 6). This made the hardware really easy to interface and minimsed mistakes with soldering and wiring. (Imagine controlling all the LEDs with its own digital pin!)</p>
<p>The state of all the LEDs are stored in an array that holds the red, green, and blue values for each LED.</p>
<div class="highlight"><pre><span></span><span class="n">CRGB</span> <span class="n">leds</span><span class="p">[</span><span class="n">NUM_LEDS</span><span class="p">];</span>
<span class="n">FastLED</span><span class="p">.</span><span class="n">addLeds</span><span class="o">&lt;</span><span class="n">WS2812</span><span class="p">,</span> <span class="n">LED_PIN</span><span class="p">,</span> <span class="n">GRB</span><span class="o">&gt;</span><span class="p">(</span><span class="n">leds</span><span class="p">,</span> <span class="n">NUM_LEDS</span><span class="p">).</span><span class="n">setCorrection</span><span class="p">(</span> <span class="n">TypicalLEDStrip</span> <span class="p">);</span>
</pre></div>
<h3 id="Setting-Colours">
<a class="anchor" href="#Setting-Colours" aria-hidden="true"><span class="octicon octicon-link"></span></a>Setting Colours<a class="anchor-link" href="#Setting-Colours"> </a>
</h3>
<p>Updating this frame buffer does not update the LEDs until you call <code>FastLED.show()</code>. Before writing to the frame buffer, I first use <code>FastLED.clear()</code> to zero all the LEDs to <code>CRGB::Black</code>.
</p>
<div class="flash flash-success">
    <svg class="octicon octicon-checklist octicon octicon-checklist octicon octicon-checklist" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M16 8.5l-6 6-3-3L8.5 10l1.5 1.5L14.5 7 16 8.5zM5.7 12.2l.8.8H2c-.55 0-1-.45-1-1V3c0-.55.45-1 1-1h7c.55 0 1 .45 1 1v6.5l-.8-.8c-.39-.39-1.03-.39-1.42 0L5.7 10.8a.996.996 0 000 1.41v-.01zM4 4h5V3H4v1zm0 2h5V5H4v1zm0 2h3V7H4v1zM3 9H2v1h1V9zm0-2H2v1h1V7zm0-2H2v1h1V5zm0-2H2v1h1V3z"></path></svg>
    <strong>Tip: </strong>Standard HTML colours can be accessed via <code>CRGB::colour_name</code>. Some examples are <code>CRGB::White</code>, <code>CRGB::Yellow</code>, <code>CRGB::Teal</code>, and <code>CRGB::Gray</code>. 
</div>
<p>You can also use the HSV colour space and set the hue, saturation, and value using <code>CHSV(unit8_t hue,unit8_t sat,unit8_t val)</code> which will automatically convert to an RGB value to be stored. <code>FastLED</code> has two rainbow spectrums - I used the default which spaces out the oranges and yellows more and is visually more "rainbow-like".</p>
<h3 id="Power-consumption">
<a class="anchor" href="#Power-consumption" aria-hidden="true"><span class="octicon octicon-link"></span></a>Power consumption<a class="anchor-link" href="#Power-consumption"> </a>
</h3>
<p>Each RGB LED can draw 60 mA and since there are 128 of them, that's 7.68 A. In all my applications, I do not need to turn all the LEDs white on max brightness anyway. I found full brightness too bright and that half brightness was good enough. I used a 5 V, 2 A phone charger. <code>FastLED</code> provides as function to limit the power consumption automatically so that LED brightnesses are modified before writing out the frame buffer. This means you can code your animations assuming full power while testing on a smaller power supply, then change a setting for deployment.</p>
<div class="highlight"><pre><span></span><span class="n">FastLED</span><span class="p">.</span><span class="n">setMaxPowerInVoltsAndMilliamps</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">500</span><span class="p">);</span> 
<span class="c1">// Also, see this function</span>
<span class="c1">// FastLED.setBrightness(  BRIGHTNESS );</span>
</pre></div>
<p>For example, if the value is 11.5 after <code>FastLED</code> adjusts the value, <code>FastLED</code> will use temporal dithering to make it appear as 11.5 by quickly switching between 11 and 12. Neat!</p>
<h3 id="Timing">
<a class="anchor" href="#Timing" aria-hidden="true"><span class="octicon octicon-link"></span></a>Timing<a class="anchor-link" href="#Timing"> </a>
</h3>
<p>Each RGB LED takes around 30 us to be written. To update the whole clock display, the whole process takes 3.84 ms. Theoretically, that means the max refresh rate is 260 Hz but it takes time to clear the frame buffer, cycle through the look up table, compute colour values and write the new animations. In practice, I found a 20 Hz refresh rate was plenty for smooth animations.</p>
<p>Instead of using the Arduino <code>delay()</code> function for timing, I used <code>FastLED.delay()</code> instead as it allows for temporal dithering as described above.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p></p>
<div class="flash flash-error">
    <svg class="octicon octicon-alert octicon octicon-alert" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 000 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 00.01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg>
    <strong>Warning: </strong><code>FastLED</code> will turn off interrupts temporarily while updating the LED strip due to the tight timing needed to write to the LEDs. 
</div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Foreground-Modes">
<a class="anchor" href="#Foreground-Modes" aria-hidden="true"><span class="octicon octicon-link"></span></a>Foreground Modes<a class="anchor-link" href="#Foreground-Modes"> </a>
</h1>
<p>When programming the animations, I decided that it would be sensible to segregate the time (and any text?) to the foreground while keeping the rest to the background. The foreground LED colour values will overwrite the background values.</p>
<p>Here's what it looks like displaying the time in rainbow colours with a black background.</p>
<p><img src="/blog/images/copied_from_nb/../images/2021-01-05-LED_clock_files/rainbow_time.gif" alt="" title="Figure 10: Time displayed in rainbow."></p>
<h2 id="Slanted-Digits">
<a class="anchor" href="#Slanted-Digits" aria-hidden="true"><span class="octicon octicon-link"></span></a>Slanted Digits<a class="anchor-link" href="#Slanted-Digits"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>I also have an option to make the time appear in slanted mode as well as a no time option. The no time option is great for seeing the background animation. In practice, you can mix and match foreground and background modes.</p>
<p><img src="/blog/images/copied_from_nb/../images/2021-01-05-LED_clock_files/slant.gif" alt="" title="Figure 11: Time displayed using slanted digits."></p>
<h1 id="Background-Animations">
<a class="anchor" href="#Background-Animations" aria-hidden="true"><span class="octicon octicon-link"></span></a>Background Animations<a class="anchor-link" href="#Background-Animations"> </a>
</h1>
<h2 id="Rolling-Rainbow">
<a class="anchor" href="#Rolling-Rainbow" aria-hidden="true"><span class="octicon octicon-link"></span></a>Rolling Rainbow<a class="anchor-link" href="#Rolling-Rainbow"> </a>
</h2>
<p>The rainbow background works well with either the foreground set to <code>CRGB::White</code> (as shown in Figure 12) or <code>CRGB::Black</code>.</p>
<p><img src="/blog/images/copied_from_nb/../images/2021-01-05-LED_clock_files/rainbow_bg.gif" alt="" title="Figure 12: Rainbow background."></p>
<h2 id="Twinkle">
<a class="anchor" href="#Twinkle" aria-hidden="true"><span class="octicon octicon-link"></span></a>Twinkle<a class="anchor-link" href="#Twinkle"> </a>
</h2>
<p>In this one, I randomly chose LEDs to flash white and fade away. 
<img src="/blog/images/copied_from_nb/../images/2021-01-05-LED_clock_files/twinkle.gif" alt="" title="Figure 13: Twinkle animation."></p>
<h2 id="Storm">
<a class="anchor" href="#Storm" aria-hidden="true"><span class="octicon octicon-link"></span></a>Storm<a class="anchor-link" href="#Storm"> </a>
</h2>
<p>In creating this storm animation, I wanted a fast way to generate random numbers. It just so happens that <code>FastLED</code> provides <code>random8</code> which I used liberally to generate a raindrop's path downward (and the lightning strikes!).</p>
<p><img src="/blog/images/copied_from_nb/../images/2021-01-05-LED_clock_files/thunder.gif" alt="" title="Figure 14: Storm animation."></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ul>
<li>Interviewer: Your resume says you are quick at generating random numbers. Give me a sequence of random numbers. </li>
<li>
<code>random8</code>: Here you go....        </li>
<li>Interviewer: That doesn't seem random to me....     </li>
<li>
<code>random8</code>: But it was quick!<br>
<div class="flash">
    <svg class="octicon octicon-info octicon octicon-info octicon octicon-info" viewbox="0 0 14 16" version="1.1" width="14" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 01-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 01-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg>
    <strong>Note: </strong><code>random8</code> is advertised as <em>fast</em> and is not truly random but for me, it is random enough. 
</div>
</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Campfire">
<a class="anchor" href="#Campfire" aria-hidden="true"><span class="octicon octicon-link"></span></a>Campfire<a class="anchor-link" href="#Campfire"> </a>
</h2>
<p>To make this firey animation, I just used <code>random8</code> to generate brightness values for the bottom four rows. Each row up is slightly less bright. I also randomly shifted the red hue towards orange.</p>
<p><img src="/blog/images/copied_from_nb/../images/2021-01-05-LED_clock_files/campfire.gif" alt="" title="Figure 15: Campfire animation."></p>
<h2 id="Fireworks">
<a class="anchor" href="#Fireworks" aria-hidden="true"><span class="octicon octicon-link"></span></a>Fireworks<a class="anchor-link" href="#Fireworks"> </a>
</h2>
<p>The fireworks animation was by far the most difficult but it looks really impressive (at least to me). The hexagonal pattern to the LEDs naturally lent itself to show an explosion of light in 6 directions. Since each LED has two LEDs directly above, I used <code>random8</code> to choose Whether the firework rises to the left or the right. More <code>random8</code> was used to change the explosion height to two different rows and the hue. Finally, I then dim the LEDs to similate the fireworks fading away.</p>
<p><img src="/blog/images/copied_from_nb/../images/2021-01-05-LED_clock_files/fireworks.gif" alt="" title="Figure 16: Fireworks animation."></p>
<h2 id="General-Animation-Method">
<a class="anchor" href="#General-Animation-Method" aria-hidden="true"><span class="octicon octicon-link"></span></a>General Animation Method<a class="anchor-link" href="#General-Animation-Method"> </a>
</h2>
<p>For each style of animation, I used a struct to define a type that defines the state of the animation. For example, let's look at the fireworks animation. In the code snippet below, the firework type holds the starting $x$ position in bottom row, the direction going north-west or north-east in the hexagon lattice, the stage or the current step in the animation sequence, the randomly generated hue, and the height offset that determines if it explodes in the top or one below row. I then create an array of these struct with size defined by <code>MAX_FIREWORKS</code>.</p>
<div class="highlight"><pre><span></span><span class="cp">#define MAX_FIREWORKS     12</span>
<span class="k">struct</span> <span class="n">firework_t</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">pos</span>       <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="c1">// LED number in last row</span>
  <span class="kt">int</span> <span class="n">direction</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="c1">// 0 is left, 1 is right</span>
  <span class="kt">int</span> <span class="n">stage</span>     <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="c1">// remember where each firework animation is up to</span>
  <span class="kt">char</span> <span class="n">hue</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="c1">// colour of each firework</span>
  <span class="kt">int</span> <span class="n">height_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// sometimes lower by one. </span>
<span class="p">};</span>
</pre></div>
<p>The next frame as defined by the user's <code>REFRESH_RATE</code> steps through the animation stages and sometimes randomly starts a new firework should the number of current fireworks be less then <code>MAX_FIREWORKS</code> with some probability. I then loop through all the array and redraw the LED states into the frame buffer according to each fireworks' current animation stage. All that's left is to define what each stage or step looks like and I used <code>if/else if</code> statements to do the job. The same method is applied for the twinkle and storm animation.</p>
<p>Together with the LED index look up table defined by a left-ward sloping parallelogram in Figure 9, and this struct based rasteriser method, it is relatively straightforward to generate your own neat animations! 
</p>
<div class="flash flash-error">
    <svg class="octicon octicon-alert octicon octicon-alert octicon octicon-alert" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 000 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 00.01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg>
    <strong>Warning: </strong>With the limited RAM in an Arduino Nano (2 KB), I found it really hard to fit more than two types of animations on chip. When the compiler gives you the warning <code>Low memory available, stability problems may occur</code> and the RAM usage is &gt;90%, be wary that your animations may freeze as it did for me. I made it work by lowering <code>MAX_FIREWORKS</code> and <code>MAX_RAINDROPS</code> until the freezing disappeared but it’ll be better to use a microcontroller with more RAM. 
</div>
<h1 id="Potential-Improvements">
<a class="anchor" href="#Potential-Improvements" aria-hidden="true"><span class="octicon octicon-link"></span></a>Potential Improvements<a class="anchor-link" href="#Potential-Improvements"> </a>
</h1>
<p>Here is a list of improvements I could make to my ping pong LED clock:</p>
<ol>
<li>Use a hardware RTC rather than use software</li>
<li>Implement scolling text</li>
<li>Use FastLED colour palettes</li>
<li>Attach light sensor and auto-adjust FastLED brightness</li>
<li>Attach PIR motion sensor and turn on display when there is someone to look at it</li>
<li>Attach temperature/humidity/pressure sensor and display stats</li>
<li>Connect to Wifi (e.g. using an ESP32)</li>
</ol>
<p>These improvements will require more hardware that I don't have right now... but you can totally put them on your shopping list when you order the materials to make your own ping pong LED clock and show me what you make!</p>
<h1 id="Conclusion">
<a class="anchor" href="#Conclusion" aria-hidden="true"><span class="octicon octicon-link"></span></a>Conclusion<a class="anchor-link" href="#Conclusion"> </a>
</h1>
<p>We saw how I put together a ping pong LED clock inspired by an instructable and some animations. Both my hardware and software design choices were explained and my code is freely available at <a href="https://github.com/YiweiMao/pingPongClock">repo link</a>.</p>
<p>I hope I inspired you to make your own ping pong LED clock with your own cool animations! Let me know how it goes in the comments below!</p>

</div>
</div>
</div>
</div>



  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="YiweiMao/blog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/blog/ping_pong_led_clock/" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/blog/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/blog/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/blog/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Teaching my past self and reminding my future self.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/YiweiMao" title="YiweiMao"><svg class="svg-icon grey"><use xlink:href="/blog/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/ewaymao" title="ewaymao"><svg class="svg-icon grey"><use xlink:href="/blog/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
